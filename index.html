<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>äº¤å·®ç‚¹ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color -->
    <meta name="theme-color" content="#ffffff">
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* iOSã§ã®ãƒã‚¦ãƒ³ã‚¹é˜²æ­¢ */
        }
        /* ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .grid-cell {
            width: 100%;
            height: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem; /* çµµæ–‡å­—ã®ã‚µã‚¤ã‚º */
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #f9fafb; /* gray-50 */
            box-sizing: border-box;
        }
        /* iPhone/iPadã§ã®ã‚¿ãƒƒãƒ—ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– */
        button, input {
            -webkit-tap-highlight-color: transparent;
        }
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã¤ã¾ã¿ã‚’å¤§ããã™ã‚‹ */
        input[type="range"]::-webkit-slider-thumb {
            width: 24px;
            height: 24px;
            margin-top: -10px; /* ä½ç½®èª¿æ•´ */
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
        }
        
        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å‘ã */
        #player {
            font-size: 1.75rem; /* ä»–ã®çµµæ–‡å­—ã‚ˆã‚Šå°‘ã—å°ã•ã */
            transition: none; /* ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ– */
            z-index: 10;
        }
        /* å‘ãã®ã‚¯ãƒ©ã‚¹ (ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤) */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- 1. è¨­å®šç”»é¢ (Settings View) -->
    <div id="settings-view" class="p-4 md:p-8 max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">äº¤å·®ç‚¹ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼è¨­å®š</h1>

        <div class="space-y-6 bg-white p-6 rounded-lg shadow-md">
            
            <!-- ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º -->
            <div>
                <label for="grid-size" class="block text-lg font-medium mb-2">ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º: <span id="grid-size-label" class="font-bold text-blue-600">4x4</span></label>
                <input id="grid-size" type="range" min="3" max="10" value="4" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
            </div>

            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ -->
            <div>
                <label for="start-coord" class="block text-lg font-medium mb-2">ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ (è¡Œ, åˆ—)</label>
                <input id="start-coord" type="text" placeholder="ä¾‹: 1,1" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
            </div>

            <!-- ã‚´ãƒ¼ãƒ«åœ°ç‚¹ -->
            <div>
                <label for="goal-coord" class="block text-lg font-medium mb-2">ã‚´ãƒ¼ãƒ«åœ°ç‚¹ (è¡Œ, åˆ—)</label>
                <input id="goal-coord" type="text" placeholder="ä¾‹: 4,4" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
            </div>

            <!-- é€šéåœ°ç‚¹ã®æ•° -->
            <div>
                <label for="waypoints-count" class="block text-lg font-medium mb-2">é€šéåœ°ç‚¹ã®æ•°: <span id="waypoints-count-label" class="font-bold text-blue-600">0</span></label>
                <input id="waypoints-count" type="range" min="0" max="3" value="0" class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
            </div>

            <!-- é€šéåœ°ç‚¹ã®åº§æ¨™ -->
            <div id="waypoints-coords-container" class="hidden">
                <label for="waypoints-coords" class="block text-lg font-medium mb-2">é€šéåœ°ç‚¹ã®åº§æ¨™ (ã‚»ãƒŸã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Š)</label>
                <input id="waypoints-coords" type="text" placeholder="ä¾‹: 2,3; 3,2" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                <button id="random-btn" class="w-full p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold active:bg-green-600 transition">
                    ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
                </button>
                <button id="start-game-btn" class="w-full p-4 bg-blue-600 text-white rounded-lg shadow-md text-lg font-semibold active:bg-blue-700 transition">
                    ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹
                </button>
            </div>
        </div>
        <p id="settings-error" class="text-red-500 text-center mt-4"></p>
    </div>

    <!-- 2. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ (Game View) -->
    <div id="game-view" class="hidden h-screen w-screen flex flex-col p-4">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (è¨­å®šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) -->
        <div class="flex justify-between items-center mb-4 w-full max-w-4xl mx-auto">
            <button id="back-to-settings-btn" class="p-3 bg-gray-200 text-gray-700 rounded-lg shadow active:bg-gray-300 transition text-lg">
                âš™ï¸ è¨­å®šã«æˆ»ã‚‹
            </button>
            <div id="message-area" class="text-xl font-semibold text-green-600 h-8"></div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ (ãƒãƒƒãƒ—ã¨æ“ä½œãƒ‘ãƒãƒ«) -->
        <div class="flex-grow flex flex-col md:flex-row gap-4 w-full max-w-4xl mx-auto overflow-hidden">
            
            <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="flex-grow flex justify-center items-center md:w-1/2">
                <div id="grid-container" class="grid bg-white shadow-lg rounded-lg border border-gray-300">
                    <!-- ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚¨ãƒªã‚¢ -->
            <div class="flex flex-col md:w-1/2 space-y-4">
                
                <!-- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨ç¤º -->
                <div class="bg-white p-4 rounded-lg shadow-md h-32 md:h-40 overflow-y-auto border">
                    <h3 class="text-lg font-semibold mb-2">ã‚·ãƒ¼ã‚±ãƒ³ã‚¹:</h3>
                    <div id="sequence-display" class="flex flex-wrap gap-2 text-2xl">
                        <!-- çŸ¢å°ã¯JSã§è¿½åŠ  -->
                    </div>
                </div>

                <!-- æ–¹å‘ãƒœã‚¿ãƒ³ (åå­—ã‚­ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ + ä¸¸æ ãªã—) -->
                <div class="grid grid-cols-3 grid-rows-3 gap-2 justify-items-center p-4 bg-white rounded-lg shadow-md">
                    <div class="col-start-2 row-start-1">
                        <button data-dir="up" class="dir-btn p-1 text-3xl transition">â¬†ï¸</button>
                    </div>
                    <div class="col-start-1 row-start-2">
                        <button data-dir="left" class="dir-btn p-1 text-3xl transition">â¬…ï¸</button>
                    </div>
                    <div class="col-start-3 row-start-2">
                        <button data-dir="right" class="dir-btn p-1 text-3xl transition">â¡ï¸</button>
                    </div>
                    <div class="col-start-2 row-start-3">
                        <button data-dir="down" class="dir-btn p-1 text-3xl transition">â¬‡ï¸</button>
                    </div>
                </div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="grid grid-cols-3 gap-2">
                    <button id="undo-btn" class="p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold active:bg-green-600 transition">ã‚‚ã©ã™</button>
                    <button id="run-btn" class="p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold active:bg-green-600 transition">å®Ÿè¡Œ</button>
                    <button id="reset-btn" class="p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold active:bg-green-600 transition">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DOMè¦ç´ ã®å–å¾— ---
            const settingsView = document.getElementById('settings-view');
            const gameView = document.getElementById('game-view');

            // è¨­å®šç”»é¢
            const gridSizeSlider = document.getElementById('grid-size');
            const gridSizeLabel = document.getElementById('grid-size-label');
            const startCoordInput = document.getElementById('start-coord');
            const goalCoordInput = document.getElementById('goal-coord');
            const waypointsCountSlider = document.getElementById('waypoints-count');
            const waypointsCountLabel = document.getElementById('waypoints-count-label');
            const waypointsCoordsContainer = document.getElementById('waypoints-coords-container');
            const waypointsCoordsInput = document.getElementById('waypoints-coords');
            const randomBtn = document.getElementById('random-btn');
            const startGameBtn = document.getElementById('start-game-btn');
            const settingsError = document.getElementById('settings-error');

            // ã‚²ãƒ¼ãƒ ç”»é¢
            const backToSettingsBtn = document.getElementById('back-to-settings-btn');
            const gridContainer = document.getElementById('grid-container');
            const sequenceDisplay = document.getElementById('sequence-display');
            const dirButtons = document.querySelectorAll('.dir-btn');
            const undoBtn = document.getElementById('undo-btn');
            const resetBtn = document.getElementById('reset-btn');
            const runBtn = document.getElementById('run-btn');
            const messageArea = document.getElementById('message-area');

            // --- 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç† ---

            // ã‚²ãƒ¼ãƒ è¨­å®šï¼ˆãƒ“ãƒ¥ãƒ¼é–“ã§å…±æœ‰ï¼‰
            let gameConfig = {
                gridSize: 4,
                start: { row: 0, col: 0 }, // 0ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                goal: { row: 3, col: 3 },  // 0ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                waypoints: []             // 0ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            };

            // ãƒ•ãƒ«ãƒ¼ãƒ„ã®çµµæ–‡å­—é…åˆ—
            const fruits = ['ğŸ', 'ğŸŠ', 'ğŸ‡', 'ğŸ“', 'ğŸ¥', 'ğŸ‰'];

            // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤çŠ¶æ…‹
            let gameState = {
                player: { row: 0, col: 0, dir: 'up' },
                sequence: [],
                collectedWaypoints: new Set(),
                isRunning: false
            };

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®DOMè¦ç´ 
            const playerElement = document.createElement('span');
            playerElement.id = 'player';
            playerElement.innerHTML = '<span>â–²</span>'; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ (åˆæœŸã¯ä¸Šå‘ã)

            // --- 3. è¨­å®šç”»é¢ (Settings View) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            gridSizeSlider.addEventListener('input', (e) => {
                const size = e.target.value;
                gameConfig.gridSize = parseInt(size);
                gridSizeLabel.textContent = `${size}x${size}`;
            });

            // é€šéåœ°ç‚¹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
            waypointsCountSlider.addEventListener('input', (e) => {
                const count = e.target.value;
                waypointsCountLabel.textContent = count;
                if (count > 0) {
                    waypointsCoordsContainer.classList.remove('hidden');
                } else {
                    waypointsCoordsContainer.classList.add('hidden');
                    waypointsCoordsInput.value = ''; // æ•°ãŒ0ãªã‚‰åº§æ¨™ã‚‚ã‚¯ãƒªã‚¢
                }
            });

            // ã€Œå®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã€ãƒœã‚¿ãƒ³
            randomBtn.addEventListener('click', () => {
                settingsError.textContent = '';
                
                // 1. ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º
                const size = getRandomInt(3, 10);
                gridSizeSlider.value = size;
                gridSizeLabel.textContent = `${size}x${size}`;
                gameConfig.gridSize = size;
                
                const maxIdx = size - 1;
                let usedCoords = new Set();

                // 2. ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹
                gameConfig.start = getRandomCoord(maxIdx, usedCoords);
                usedCoords.add(coordToString(gameConfig.start));
                startCoordInput.value = `${gameConfig.start.row + 1},${gameConfig.start.col + 1}`; // 1ãƒ™ãƒ¼ã‚¹ã§è¡¨ç¤º

                // 3. ã‚´ãƒ¼ãƒ«åœ°ç‚¹
                gameConfig.goal = getRandomCoord(maxIdx, usedCoords);
                usedCoords.add(coordToString(gameConfig.goal));
                goalCoordInput.value = `${gameConfig.goal.row + 1},${gameConfig.goal.col + 1}`; // 1ãƒ™ãƒ¼ã‚¹ã§è¡¨ç¤º
                
                // 4. é€šéåœ°ç‚¹
                const waypointsCount = getRandomInt(0, 3);
                waypointsCountSlider.value = waypointsCount;
                waypointsCountLabel.textContent = waypointsCount;
                
                gameConfig.waypoints = [];
                if (waypointsCount > 0) {
                    waypointsCoordsContainer.classList.remove('hidden');
                    let waypointsCoordsStr = [];
                    for (let i = 0; i < waypointsCount; i++) {
                        const waypoint = getRandomCoord(maxIdx, usedCoords);
                        usedCoords.add(coordToString(waypoint));
                        gameConfig.waypoints.push(waypoint);
                        waypointsCoordsStr.push(`${waypoint.row + 1},${waypoint.col + 1}`); // 1ãƒ™ãƒ¼ã‚¹
                    }
                    waypointsCoordsInput.value = waypointsCoordsStr.join('; ');
                } else {
                    waypointsCoordsContainer.classList.add('hidden');
                    waypointsCoordsInput.value = '';
                }
            });

            // ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³
            startGameBtn.addEventListener('click', () => {
                if (parseSettings()) {
                    showGameView();
                }
            });

            // è¨­å®šã®ãƒ‘ãƒ¼ã‚¹ã¨æ¤œè¨¼
            function parseSettings() {
                settingsError.textContent = '';
                const size = parseInt(gridSizeSlider.value);
                gameConfig.gridSize = size;

                try {
                    // 1. ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®ãƒ‘ãƒ¼ã‚¹
                    const start = parseCoord(startCoordInput.value, size);
                    if (!start) throw new Error('ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®åº§æ¨™ãŒç„¡åŠ¹ã§ã™ã€‚');
                    gameConfig.start = start;

                    // 2. ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã®ãƒ‘ãƒ¼ã‚¹
                    const goal = parseCoord(goalCoordInput.value, size);
                    if (!goal) throw new Error('ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã®åº§æ¨™ãŒç„¡åŠ¹ã§ã™ã€‚');
                    gameConfig.goal = goal;

                    // 3. é€šéåœ°ç‚¹ã®ãƒ‘ãƒ¼ã‚¹
                    const waypointsCount = parseInt(waypointsCountSlider.value);
                    gameConfig.waypoints = [];
                    if (waypointsCount > 0) {
                        const waypointStrings = waypointsCoordsInput.value.split(';')
                                                    .map(s => s.trim()).filter(s => s);
                        if (waypointStrings.length !== waypointsCount) {
                            throw new Error(`é€šéåœ°ç‚¹ã®åº§æ¨™ã‚’${waypointsCount}å€‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                        }
                        for (const str of waypointStrings) {
                            const waypoint = parseCoord(str, size);
                            if (!waypoint) throw new Error(`é€šéåœ°ç‚¹ã®åº§æ¨™ã€Œ${str}ã€ãŒç„¡åŠ¹ã§ã™ã€‚`);
                            gameConfig.waypoints.push(waypoint);
                        }
                    }

                    // 4. é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const coords = [gameConfig.start, gameConfig.goal, ...gameConfig.waypoints];
                    const coordSet = new Set(coords.map(coordToString));
                    if (coordSet.size !== coords.length) {
                        throw new Error('ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚´ãƒ¼ãƒ«ã€é€šéåœ°ç‚¹ã®åº§æ¨™ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚');
                    }

                    return true; // æ­£å¸¸çµ‚äº†

                } catch (error) {
                    settingsError.textContent = error.message;
                    return false;
                }
            }

            // --- 4. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ (Game View) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ã€Œè¨­å®šã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
            backToSettingsBtn.addEventListener('click', showSettingsView);

            // æ–¹å‘ãƒœã‚¿ãƒ³
            dirButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (gameState.isRunning) return;
                    const dir = button.dataset.dir;
                    gameState.sequence.push(dir);
                    updateSequenceDisplay();
                });
            });

            // ã€Œæˆ»ã™ (UNDO)ã€ãƒœã‚¿ãƒ³
            undoBtn.addEventListener('click', () => {
                if (gameState.isRunning) return;
                gameState.sequence.pop();
                updateSequenceDisplay();
            });

            // ã€Œãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³
            resetBtn.addEventListener('click', () => {
                if (gameState.isRunning) return;
                gameState.sequence = [];
                updateSequenceDisplay();
                resetPlayer();
                messageArea.textContent = 'ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
                setTimeout(() => messageArea.textContent = '', 2000);
            });

            // ã€Œå®Ÿè¡Œ (RUN)ã€ãƒœã‚¿ãƒ³
            runBtn.addEventListener('click', () => {
                if (gameState.isRunning || gameState.sequence.length === 0) return;
                runSequence();
            });

            // --- 5. ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ ---

            function showSettingsView() {
                gameView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                gameState.sequence = [];
                updateSequenceDisplay();
                messageArea.textContent = '';
            }

            function showGameView() {
                settingsView.classList.add('hidden');
                gameView.classList.remove('hidden');
                generateMap();
                resetPlayer();
            }

            // --- 6. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ãƒãƒƒãƒ—ç”Ÿæˆ
            function generateMap() {
                gridContainer.innerHTML = ''; // ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
                gridContainer.style.gridTemplateColumns = `repeat(${gameConfig.gridSize}, minmax(0, 1fr))`;
                gridContainer.style.width = '100%';
                gridContainer.style.maxWidth = '500px'; // ãƒãƒƒãƒ—ã®æœ€å¤§å¹…

                for (let r = 0; r < gameConfig.gridSize; r++) {
                    for (let c = 0; c < gameConfig.gridSize; c++) {
                        const cell = document.createElement('div');
                        cell.id = `cell-${r}-${c}`;
                        cell.className = 'grid-cell';

                        // è¦ç´ ã®é…ç½®
                        if (r === gameConfig.goal.row && c === gameConfig.goal.col) {
                            cell.textContent = 'â­ï¸';
                        } else if (r === gameConfig.start.row && c === gameConfig.start.col) {
                            // cell.textContent = 'ğŸ”¥'; // ã‚¹ã‚¿ãƒ¼ãƒˆã®ç‚ã‚’å‰Šé™¤
                        } else if (gameConfig.waypoints.some(wp => wp.row === r && wp.col === c)) {
                            cell.textContent = fruits[Math.floor(Math.random() * fruits.length)];
                        }
                        gridContainer.appendChild(cell);
                    }
                }
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ– (ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã™)
            function resetPlayer() {
                gameState.player.row = gameConfig.start.row;
                gameState.player.col = gameConfig.start.col;
                gameState.player.dir = 'up'; // åˆæœŸå‘ã
                playerElement.innerHTML = '<span>â–²</span>'; // åˆæœŸçµµæ–‡å­—
                gameState.collectedWaypoints.clear();
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®ã‚»ãƒ«ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é…ç½®
                const startCell = document.getElementById(`cell-${gameConfig.start.row}-${gameConfig.start.col}`);
                if (startCell) {
                    // æ—¢å­˜ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ç´ ã‚’å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
                    playerElement.remove();
                    startCell.appendChild(playerElement);
                }
            }

            // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Ÿè¡Œ
            async function runSequence() {
                gameState.isRunning = true;
                setButtonsDisabled(true);
                messageArea.textContent = 'å®Ÿè¡Œä¸­...';
                
                resetPlayer(); // å®Ÿè¡Œå‰ã«å¿…ãšãƒªã‚»ãƒƒãƒˆ

                await delay(300); // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã§ä¸€ç¬å¾…ã¤

                for (const dir of gameState.sequence) {
                    // 1. å‘ãã‚’å¤‰ãˆã‚‹
                    changeDirection(dir);
                    
                    // 2. ç§»å‹•å…ˆã‚’è¨ˆç®—
                    let nextRow = gameState.player.row;
                    let nextCol = gameState.player.col;

                    if (dir === 'up') nextRow--;
                    else if (dir === 'down') nextRow++;
                    else if (dir === 'left') nextCol--;
                    else if (dir === 'right') nextCol++;

                    // 3. ãƒãƒƒãƒ—å¤–ãƒã‚§ãƒƒã‚¯
                    if (nextRow < 0 || nextRow >= gameConfig.gridSize || nextCol < 0 || nextCol >= gameConfig.gridSize) {
                        messageArea.textContent = 'ãƒãƒƒãƒ—ã®å¤–ã«å‡ºã¾ã—ãŸï¼';
                        await delay(500); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                        break; // å®Ÿè¡Œä¸­æ­¢
                    }

                    // 4. ç§»å‹•
                    gameState.player.row = nextRow;
                    gameState.player.col = nextCol;
                    const nextCell = document.getElementById(`cell-${nextRow}-${nextCol}`);
                    nextCell.appendChild(playerElement);
                    
                    // 5. é€šéåœ°ç‚¹ãƒã‚§ãƒƒã‚¯
                    if (gameConfig.waypoints.some(wp => wp.row === nextRow && wp.col === nextCol)) {
                        gameState.collectedWaypoints.add(coordToString({row: nextRow, col: nextCol}));
                    }

                    // 6. ã‚´ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆé€”ä¸­ã§ã‚´ãƒ¼ãƒ«ã«ã¤ã„ã¦ã‚‚OKï¼‰
                    if (nextRow === gameConfig.goal.row && nextCol === gameConfig.goal.col) {
                        // ã‚´ãƒ¼ãƒ«ã«åˆ°é”
                    }

                    await delay(300); // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã®ãƒ‡ã‚£ãƒ¬ã‚¤
                }

                // 7. æœ€çµ‚åˆ¤å®š
                checkGoal();

                gameState.isRunning = false;
                setButtonsDisabled(false);
            }

            // å‘ãã®å¤‰æ›´
            function changeDirection(dir) {
                gameState.player.dir = dir;
                if (dir === 'up') {
                    playerElement.innerHTML = '<span>â–²</span>';
                } else if (dir === 'down') {
                    playerElement.innerHTML = '<span>â–¼</span>';
                } else if (dir === 'left') {
                    playerElement.innerHTML = '<span class="text-green-600">â—€</span>';
                } else if (dir === 'right') {
                    playerElement.innerHTML = '<span>â–¶</span>';
                }
            }
            
            // ã‚´ãƒ¼ãƒ«åˆ¤å®š
            function checkGoal() {
                const atGoal = gameState.player.row === gameConfig.goal.row && gameState.player.col === gameConfig.goal.col;
                const allWaypoints = gameState.collectedWaypoints.size === gameConfig.waypoints.length;

                if (atGoal && allWaypoints) {
                    messageArea.textContent = 'ğŸ‰ ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰';
                } else if (atGoal) {
                    messageArea.textContent = 'ã‚´ãƒ¼ãƒ«ï¼ã§ã‚‚é€šéåœ°ç‚¹ãŒ... ğŸ’';
                } else {
                    messageArea.textContent = 'ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                }
            }

            // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨ç¤ºã®æ›´æ–°
            function updateSequenceDisplay() {
                const dirMap = { 'up': 'â¬†ï¸', 'down': 'â¬‡ï¸', 'left': 'â¬…ï¸', 'right': 'â¡ï¸' };
                sequenceDisplay.innerHTML = gameState.sequence.map(dir => 
                    `<span class="p-1 bg-gray-100 rounded">${dirMap[dir]}</span>`
                ).join('');
            }

            // å®Ÿè¡Œä¸­ãªã©ã«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            function setButtonsDisabled(disabled) {
                runBtn.disabled = disabled;
                resetBtn.disabled = disabled;
                undoBtn.disabled = disabled;
                backToSettingsBtn.disabled = disabled;
                dirButtons.forEach(btn => btn.disabled = disabled);
                
                // ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
                const buttons = [runBtn, resetBtn, undoBtn, backToSettingsBtn, ...dirButtons];
                buttons.forEach(btn => {
                    if (disabled) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            }

            // --- 7. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

            // åº§æ¨™æ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹ (1ãƒ™ãƒ¼ã‚¹å…¥åŠ›ã‚’0ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›)
            function parseCoord(str, gridSize) {
                const parts = str.split(',').map(s => s.trim());
                if (parts.length !== 2) return null;
                const row = parseInt(parts[0]) - 1; // 1ãƒ™ãƒ¼ã‚¹ -> 0ãƒ™ãƒ¼ã‚¹
                const col = parseInt(parts[1]) - 1; // 1ãƒ™ãƒ¼ã‚¹ -> 0ãƒ™ãƒ¼ã‚¹
                if (isNaN(row) || isNaN(col) || row < 0 || row >= gridSize || col < 0 || col >= gridSize) {
                    return null;
                }
                return { row, col };
            }

            // åº§æ¨™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Setç”¨ã®æ–‡å­—åˆ—ã«å¤‰æ›
            function coordToString(coord) {
                return `${coord.row},${coord.col}`;
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            // é‡è¤‡ã—ãªã„ãƒ©ãƒ³ãƒ€ãƒ ãªåº§æ¨™ã‚’ç”Ÿæˆ (0ãƒ™ãƒ¼ã‚¹)
            function getRandomCoord(maxIdx, usedCoords) {
                let coord;
                do {
                    coord = {
                        row: getRandomInt(0, maxIdx),
                        col: getRandomInt(0, maxIdx)
                    };
                } while (usedCoords.has(coordToString(coord)));
                return coord;
            }
            
            // ãƒ‡ã‚£ãƒ¬ã‚¤é–¢æ•°
            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // --- 8. PWAã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ² ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

            // --- 9. åˆæœŸåŒ– ---
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§UIã‚’åˆæœŸåŒ–
            gridSizeSlider.dispatchEvent(new Event('input'));
            waypointsCountSlider.dispatchEvent(new Event('input'));
            // èµ·å‹•æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ è¨­å®šã‚’é©ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            randomBtn.click();
        });
    </script>
</body>
</html>
