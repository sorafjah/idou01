<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>äº¤å·®ç‚¹ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN (ã‚µã‚¦ãƒ³ãƒ‰ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color -->
    <meta name="theme-color" content="#ffffff">
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* iOSã§ã®ãƒã‚¦ãƒ³ã‚¹é˜²æ­¢ */
        }
        /* ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .grid-cell {
            width: 100%;
            height: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; /* ã‚²ãƒ¼ãƒ ç”»é¢ã®çµµæ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #f9fafb; /* gray-50 */
            box-sizing: border-box;
            position: relative; /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ãŸã‚ */
        }
        /* è¨­å®šç”»é¢ç”¨ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ« */
        .setting-grid-cell {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            border: 1px solid #e5e7eb; /* gray-200 */
            background-color: #f9fafb; /* gray-50 */
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .setting-grid-cell:hover {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* iPhone/iPadã§ã®ã‚¿ãƒƒãƒ—ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç„¡åŠ¹åŒ– */
        button, input {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å‘ã */
        #player {
            font-size: 1.25rem; /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚­ãƒ£ãƒ©ã‚µã‚¤ã‚ºèª¿æ•´ */
            transition: none;
            z-index: 10;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã®æ“ä½œãƒœã‚¿ãƒ³ (ã‚¿ãƒ–é¢¨) */
        .operation-btn {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #f9fafb; /* gray-50 */
            color: #374151; /* gray-700 */
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
            border-radius: 0.375rem; /* rounded-md */
        }
        .operation-btn:active {
            background-color: #e5e7eb; /* gray-200 */
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mode-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            color: #6b7280;
            transition: background-color 0.2s, color 0.2s;
        }
        .mode-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }

        /* å›è»¢çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ */
        .turn-left-icon {
            display: inline-block;
            transform: rotate(-90deg);
        }
        .turn-right-icon {
            display: inline-block;
            transform: rotate(-90deg); /* 90deg ã‹ã‚‰ -90deg ã«å¤‰æ›´ */
        }

        /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes ping-effect {
            0% { transform: scale(1); opacity: 1; }
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        @keyframes tada-effect {
            0% { transform: scale(1); }
            10%, 20% { transform: scale(0.9) rotate(-3deg); }
            30%, 50%, 70%, 90% { transform: scale(1.1) rotate(3deg); }
            40%, 60%, 80% { transform: scale(1.1) rotate(-3deg); }
            100% { transform: scale(1) rotate(0); }
        }
        .effect-ping {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(34, 197, 94, 0.5); /* green-500/50 */
            animation: ping-effect 1s cubic-bezier(0, 0, 0.2, 1);
            z-index: 5; /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ˆã‚Šä¸‹ */
        }
        .effect-tada {
            animation: tada-effect 1s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen w-screen overflow-hidden">

    <!-- 1. è¨­å®šç”»é¢ (Settings View) -->
    <div id="settings-view" class="p-4 md:p-8 max-w-4xl mx-auto h-full overflow-y-auto">
        <!-- <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">äº¤å·®ç‚¹ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼è¨­å®š</h1> -->
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">&nbsp;</h1> <!-- é«˜ã•ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ -->

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- å·¦å´: è¨­å®šå…¥åŠ› -->
            <div class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                
                <!-- ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º -->
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-medium px-2">ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º</legend>
                    <div class="flex gap-4">
                        <div>
                            <label for="grid-rows" class="block text-md font-medium mb-2">è¡Œæ•° (Rows)</label>
                            <input id="grid-rows" type="number" min="3" max="10" value="4" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
                        </div>
                        <div>
                            <label for="grid-cols" class="block text-md font-medium mb-2">åˆ—æ•° (Cols)</label>
                            <input id="grid-cols" type="number" min="3" max="10" value="5" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
                        </div>
                    </div>
                </fieldset>

                <!-- é€šéåœ°ç‚¹ã®æ•° (å‰Šé™¤) -->
                <!-- 
                <div>
                    <label for="waypoints-count" class="block text-lg font-medium mb-2">é€šéåœ°ç‚¹ã®æ•° (æœ€å¤§3)</label>
                    <input id="waypoints-count" type="number" min="0" max="3" value="0" class="w-full p-3 border border-gray-300 rounded-lg text-lg">
                </div>
                -->

                <!-- ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ -->
                <fieldset class="border p-4 rounded-lg">
                    <legend class="text-lg font-medium px-2">ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ</legend>
                    <div id="item-selector" class="flex flex-wrap gap-x-4 gap-y-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="start" class="form-radio" checked>
                            <span class="text-lg">ğŸï¸ (ã‚¹ã‚¿ãƒ¼ãƒˆ)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="goal" class="form-radio">
                            <span class="text-lg">ğŸ  (ã‚´ãƒ¼ãƒ«)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="waypoint" class="form-radio">
                            <span class="text-lg">ğŸ” (é€šéåœ°ç‚¹)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="wall" class="form-radio">
                            <span class="text-lg">âŒ (é€šè¡Œä¸å¯)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="item-type" value="erase" class="form-radio">
                            <span class="text-lg">ğŸ—‘ï¸ (æ¶ˆã—ã‚´ãƒ )</span>
                        </label>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">â€»é€šéåœ°ç‚¹ã¯ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ã‚¤ã‚³ãƒ³ã§é…ç½®ã•ã‚Œã¾ã™ã€‚(æœ€å¤§6å€‹)</p>
                </fieldset>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="space-y-4 pt-4">
                    <button id="random-all-btn" class="w-full p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold active:bg-green-600 transition">
                        ğŸ² å…¨è¨­å®šãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ (å£ãªã—)
                    </button>
                    <button id="random-items-btn" class="w-full p-4 bg-green-500 text-white rounded-lg shadow-md text-lg font-semibold active:bg-green-600 transition">
                        ğŸ”„ ã‚¢ã‚¤ãƒ†ãƒ é…ç½®ãƒ©ãƒ³ãƒ€ãƒ åŒ– (å£ãªã—)
                    </button>
                    <button id="start-game-btn" class="w-full p-4 bg-blue-600 text-white rounded-lg shadow-md text-lg font-semibold active:bg-blue-700 transition">
                        ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹
                    </button>
                </div>
                <p id="settings-error" class="text-red-500 text-center h-6"></p>

            </div>

            <!-- å³å´: ã‚°ãƒªãƒƒãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-center">é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <div id="setting-grid-container" class="grid bg-white border border-gray-300 rounded-lg overflow-hidden">
                    <!-- è¨­å®šã‚°ãƒªãƒƒãƒ‰ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

        </div>
    </div>

    <!-- 2. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ (Game View) -->
    <div id="game-view" class="hidden h-screen w-screen flex flex-col p-4">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (è¨­å®šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) -->
        <div class="flex justify-between items-center mb-4 w-full max-w-7xl mx-auto flex-shrink-0">
            <!-- <button id="back-to-settings-btn" class="text-blue-600 hover:underline text-lg">è¨­å®šã«æˆ»ã‚‹</button> --> <!-- ç§»å‹• -->
            <span class="text-lg">&nbsp;</span> <!-- å·¦ä¸Šã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ç”¨ -->
            <div id="message-area" class="text-xl font-semibold text-green-600 h-8 text-right"></div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ (å·¦å³åè»¢ã€ã‚°ãƒªãƒƒãƒ‰ãŒå³) -->
        <div class="flex-grow flex flex-col md:flex-row-reverse gap-4 w-full max-w-7xl mx-auto overflow-hidden">
            
            <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ (å³å´ã€å¹…ã‚’åºƒã) -->
            <div class="flex-grow flex justify-center items-center md:w-3/5 h-full">
                <div id="grid-container" class="grid bg-white shadow-lg rounded-lg border border-gray-300">
                    <!-- ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚¨ãƒªã‚¢ (å·¦å´ã€å¹…ã‚’ç‹­ã) -->
            <div class="flex flex-col md:w-2/5 space-y-4 h-full">
                
                <!-- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨ç¤º (é«˜ã•ã‚’å¯å¤‰ã«) -->
                <div class="bg-white p-4 rounded-lg shadow-md border flex-grow overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-2">ã‚·ãƒ¼ã‚±ãƒ³ã‚¹:</h3>
                    <div id="sequence-display" class="flex flex-wrap gap-2 text-xl">
                        <!-- çŸ¢å°ã¯JSã§è¿½åŠ  -->
                    </div>
                </div>

                <!-- æ“ä½œãƒ‘ãƒãƒ« (ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«) -->
                <div class="flex-shrink-0 flex flex-col space-y-4">
                    
                    <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (å¾©æ´») -->
                    <div class="flex rounded-md shadow-sm">
                        <button id="mode-absolute-btn" class="mode-btn active w-1/2 rounded-l-md">çµ¶å¯¾æ–¹ä½</button>
                        <button id="mode-relative-btn" class="mode-btn w-1/2 rounded-r-md">ç›¸å¯¾æ–¹ä½</button>
                    </div>

                    <!-- æ–¹å‘ãƒœã‚¿ãƒ³ (å‹•çš„) -->
                    <div id="direction-pad" class="p-3 bg-white rounded-lg shadow-md h-[160px] flex justify-center items-center">
                        <!-- JSã§å‹•çš„ã«ä¸­èº«ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ (ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´) -->
                    <div class="grid grid-cols-3 gap-2">
                        <button id="undo-btn" class="p-3 bg-blue-500 text-white rounded-lg shadow-md text-md font-semibold active:bg-blue-600 transition">ã‚‚ã©ã™</button>
                        <button id="reset-btn" class="p-3 bg-blue-500 text-white rounded-lg shadow-md text-md font-semibold active:bg-blue-600 transition">ã‚¯ãƒªã‚¢</button>
                        <button id="run-btn" class="p-3 bg-green-500 text-white rounded-lg shadow-md text-md font-semibold active:bg-green-600 transition">å®Ÿè¡Œ</button>
                    </div>

                    <!-- è¨­å®šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ (ç§»å‹•) -->
                    <button id="back-to-settings-btn" class="text-gray-500 hover:underline text-center text-lg p-2">
                        è¨­å®šã«æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DOMè¦ç´ ã®å–å¾— ---
            const settingsView = document.getElementById('settings-view');
            const gameView = document.getElementById('game-view');

            // è¨­å®šç”»é¢
            const gridRowsInput = document.getElementById('grid-rows');
            const gridColsInput = document.getElementById('grid-cols');
            // const waypointsCountInput = document.getElementById('waypoints-count'); // å‰Šé™¤
            const itemSelector = document.getElementById('item-selector');
            const settingGridContainer = document.getElementById('setting-grid-container');
            const randomAllBtn = document.getElementById('random-all-btn');
            const randomItemsBtn = document.getElementById('random-items-btn');
            const startGameBtn = document.getElementById('start-game-btn');
            const settingsError = document.getElementById('settings-error');

            // ã‚²ãƒ¼ãƒ ç”»é¢
            const backToSettingsBtn = document.getElementById('back-to-settings-btn');
            const gridContainer = document.getElementById('grid-container');
            const sequenceDisplay = document.getElementById('sequence-display');
            const directionPad = document.getElementById('direction-pad');
            const modeAbsoluteBtn = document.getElementById('mode-absolute-btn'); // å¾©æ´»
            const modeRelativeBtn = document.getElementById('mode-relative-btn'); // å¾©æ´»
            const undoBtn = document.getElementById('undo-btn');
            const resetBtn = document.getElementById('reset-btn');
            const runBtn = document.getElementById('run-btn');
            const messageArea = document.getElementById('message-area');

            // --- 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç† ---

            // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®çµµæ–‡å­—é…åˆ— (å¤‰æ›´)
            const allWaypointIcons = ['ğŸ”', 'ğŸ', 'ğŸ°', 'ğŸ‰', 'ğŸ“', 'ğŸ‡', 'ğŸ¥', 'ğŸ', 'ğŸ•', 'ğŸ©', 'ğŸ¥', 'ğŸ—', 'â¤ï¸', 'ğŸ’š', 'ğŸ’›', 'ğŸ’™', 'ğŸ©·'];
            let landmarks = allWaypointIcons.sort(() => 0.5 - Math.random()).slice(0, 6); // åˆæœŸã‚·ãƒ£ãƒƒãƒ•ãƒ«

            // ã‚²ãƒ¼ãƒ è¨­å®šï¼ˆãƒ“ãƒ¥ãƒ¼é–“ã§å…±æœ‰ï¼‰
            let gameConfig = {
                gridRows: 4,
                gridCols: 5,
                start: null, // { row: r, col: c }
                goal: null,  // { row: r, col: c }
                waypoints: [], // { row: r, col: c, icon: 'ğŸ”' }
                walls: [], // { row: r, col: c }
                waypointsCount: 0 // é…ç½®ã•ã‚ŒãŸæ•°ï¼ˆãƒ‘ãƒ¼ã‚¹æ™‚ã«ç¢ºå®šï¼‰
            };

            // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤çŠ¶æ…‹
            let gameState = {
                player: { row: 0, col: 0, dir: 'up' },
                sequence: [],
                collectedWaypoints: new Set(),
                isRunning: false,
                moveMode: 'absolute' // å¾©æ´» (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ 'absolute')
            };

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®DOMè¦ç´ 
            const playerElement = document.createElement('span');
            playerElement.id = 'player';
            playerElement.innerHTML = '<span class="text-green-600">â–²</span>'; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ (åˆæœŸã¯ä¸Šå‘ãã€ç·‘è‰²ã«å¤‰æ›´)

            // ã‚µã‚¦ãƒ³ãƒ‰ç”¨ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼
            let synth;

            // --- 3. è¨­å®šç”»é¢ (Settings View) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
            gridRowsInput.addEventListener('input', updateSettingGrid);
            gridColsInput.addEventListener('input', updateSettingGrid);
            // waypointsCountInput ã‚¤ãƒ™ãƒ³ãƒˆ (å‰Šé™¤)

            // è¨­å®šã‚°ãƒªãƒƒãƒ‰ã®ç”Ÿæˆ
            function updateSettingGrid() {
                // (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯: ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´ã€ã‚»ãƒ«ã®å†ç”Ÿæˆ)
                let rows = parseInt(gridRowsInput.value);
                let cols = parseInt(gridColsInput.value);
                rows = Math.min(Math.max(rows, 3), 10);
                cols = Math.min(Math.max(cols, 3), 10);
                gridRowsInput.value = rows;
                gridColsInput.value = cols;
                gameConfig.gridRows = rows;
                gameConfig.gridCols = cols;
                settingGridContainer.innerHTML = '';
                settingGridContainer.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;

                // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ãŒæ–°ã—ã„ã‚°ãƒªãƒƒãƒ‰å¤–ã«å‡ºãªã„ã‹ãƒã‚§ãƒƒã‚¯
                if (gameConfig.start && (gameConfig.start.row >= rows || gameConfig.start.col >= cols)) gameConfig.start = null;
                if (gameConfig.goal && (gameConfig.goal.row >= rows || gameConfig.goal.col >= cols)) gameConfig.goal = null;
                gameConfig.waypoints = gameConfig.waypoints.filter(wp => wp.row < rows && wp.col < cols);
                gameConfig.walls = gameConfig.walls.filter(w => w.row < rows && w.col < cols);
                
                // ã‚¢ã‚¤ã‚³ãƒ³å†å‰²ã‚Šå½“ã¦
                gameConfig.waypoints.forEach((wp, i) => { wp.icon = landmarks[i]; });

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'setting-grid-cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.addEventListener('click', onSettingCellClick);
                        settingGridContainer.appendChild(cell);
                    }
                }
                updateSettingGridUI();
            }

            // è¨­å®šã‚°ãƒªãƒƒãƒ‰ã®ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
            function onSettingCellClick(e) {
                // e.targetãŒ.setting-grid-cellã§ãªã„å ´åˆ(ä¾‹ãˆã°çµµæ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ)
                const targetCell = e.target.closest('.setting-grid-cell');
                if (!targetCell) return;

                const row = parseInt(targetCell.dataset.row);
                const col = parseInt(targetCell.dataset.col);
                const coord = { row, col };
                const selectedItem = itemSelector.querySelector('input[name="item-type"]:checked').value;

                // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒã‚§ãƒƒã‚¯
                const isStart = gameConfig.start && gameConfig.start.row === row && gameConfig.start.col === col;
                const isGoal = gameConfig.goal && gameConfig.goal.row === row && gameConfig.goal.col === col;
                const waypointIndex = gameConfig.waypoints.findIndex(wp => wp.row === row && wp.col === col);
                const wallIndex = gameConfig.walls.findIndex(w => w.row === row && w.col === col);

                // ä»–ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…ˆã«å‰Šé™¤
                if (selectedItem !== 'start' && isStart) gameConfig.start = null;
                if (selectedItem !== 'goal' && isGoal) gameConfig.goal = null;
                if (selectedItem !== 'waypoint' && waypointIndex > -1) gameConfig.waypoints.splice(waypointIndex, 1);
                if (selectedItem !== 'wall' && wallIndex > -1) gameConfig.walls.splice(wallIndex, 1);

                switch (selectedItem) {
                    case 'start':
                        gameConfig.start = coord;
                        break;
                    case 'goal':
                        gameConfig.goal = coord;
                        break;
                    case 'waypoint':
                        if (waypointIndex === -1) { // æ–°è¦è¿½åŠ ã®ã¿
                            if (gameConfig.waypoints.length < 6) { // æœ€å¤§6å€‹ã«å›ºå®š
                                const icon = landmarks[gameConfig.waypoints.length];
                                gameConfig.waypoints.push({ row, col, icon });
                            } else {
                                settingsError.textContent = `é€šéåœ°ç‚¹ã¯6å€‹ã¾ã§ã§ã™ã€‚`;
                                setTimeout(() => settingsError.textContent = '', 2000);
                            }
                        }
                        break;
                    case 'wall':
                        if (wallIndex === -1) { // æ–°è¦è¿½åŠ ã®ã¿
                            gameConfig.walls.push(coord);
                        }
                        break;
                    case 'erase':
                        // æ—¢ã«å‰Šé™¤æ¸ˆã¿
                        break;
                }
                
                // ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸå ´åˆã€ã‚¢ã‚¤ã‚³ãƒ³ã®å†å‰²ã‚Šå½“ã¦
                if ((selectedItem === 'erase' || selectedItem === 'waypoint') && waypointIndex > -1) {
                    gameConfig.waypoints.forEach((wp, i) => { wp.icon = landmarks[i]; });
                }

                updateSettingGridUI();
            }

            // è¨­å®šã‚°ãƒªãƒƒãƒ‰ã®è¡¨ç¤ºæ›´æ–°
            function updateSettingGridUI() {
                settingGridContainer.querySelectorAll('.setting-grid-cell').forEach(cell => {
                    cell.textContent = '';
                });

                // å£ (æœ€èƒŒé¢)
                gameConfig.walls.forEach(wall => {
                    const cell = getSettingCell(wall.row, wall.col);
                    if (cell) cell.textContent = 'âŒ';
                });
                // é€šéåœ°ç‚¹
                gameConfig.waypoints.forEach(wp => {
                    const cell = getSettingCell(wp.row, wp.col);
                    if (cell) cell.textContent = wp.icon;
                });
                // ã‚´ãƒ¼ãƒ«
                if (gameConfig.goal) {
                    const cell = getSettingCell(gameConfig.goal.row, gameConfig.goal.col);
                    if (cell) cell.textContent = 'ğŸ ';
                }
                // ã‚¹ã‚¿ãƒ¼ãƒˆ (æœ€å‰é¢)
                if (gameConfig.start) {
                    const cell = getSettingCell(gameConfig.start.row, gameConfig.start.col);
                    if (cell) cell.textContent = 'ğŸï¸';
                }
            }

            function getSettingCell(row, col) {
                return settingGridContainer.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            }

            // ã€Œå…¨è¨­å®šãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã€
            randomAllBtn.addEventListener('click', () => {
                const rows = getRandomInt(3, 10);
                const cols = getRandomInt(3, 10);
                gridRowsInput.value = rows;
                gridColsInput.value = cols;
                gameConfig.gridRows = rows;
                gameConfig.gridCols = cols;

                // 0ã€œ6å€‹ã®é€šéåœ°ç‚¹ã‚’ã€Œé…ç½®ã€ã™ã‚‹ä»•æ§˜ã«å¤‰æ›´
                gameConfig.waypointsCount = getRandomInt(0, 6); // 0-6å€‹ã«åˆ¶é™
                
                randomizeItemPlacement();
                updateSettingGrid();
            });

            // ã€Œã‚¢ã‚¤ãƒ†ãƒ é…ç½®ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã€
            randomItemsBtn.addEventListener('click', () => {
                gameConfig.gridRows = parseInt(gridRowsInput.value);
                gameConfig.gridCols = parseInt(gridColsInput.value);
                // gameConfig.waypointsCount = parseInt(waypointsCountInput.value); // å‰Šé™¤
                // ä»£ã‚ã‚Šã«ã€ç¾åœ¨é…ç½®ã•ã‚Œã¦ã„ã‚‹é€šéåœ°ç‚¹ã®æ•°ã‚’ç¶­æŒã™ã‚‹
                gameConfig.waypointsCount = gameConfig.waypoints.length;
                
                randomizeItemPlacement();
                updateSettingGridUI();
            });

            // ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ãƒ­ã‚¸ãƒƒã‚¯æœ¬ä½“
            function randomizeItemPlacement() {
                const rows = gameConfig.gridRows;
                const cols = gameConfig.gridCols;
                const count = gameConfig.waypointsCount; // å®Ÿéš›ã«é…ç½®ã™ã‚‹æ•°
                let usedCoords = new Set();
                
                landmarks = allWaypointIcons.sort(() => 0.5 - Math.random()).slice(0, 6); // å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                gameConfig.walls = []; // ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã§ã¯å£ã¯ã‚¯ãƒªã‚¢

                gameConfig.start = getRandomCoord(rows, cols, usedCoords);
                usedCoords.add(coordToString(gameConfig.start));

                gameConfig.goal = getRandomCoord(rows, cols, usedCoords);
                usedCoords.add(coordToString(gameConfig.goal));

                gameConfig.waypoints = [];
                for (let i = 0; i < count; i++) {
                    const waypoint = getRandomCoord(rows, cols, usedCoords);
                    usedCoords.add(coordToString(waypoint));
                    gameConfig.waypoints.push({ row: waypoint.row, col: waypoint.col, icon: landmarks[i] });
                }
            }

            // ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³
            startGameBtn.addEventListener('click', async () => {
                await initAudio(); // ã‚µã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
                if (parseSettings()) {
                    showGameView();
                }
            });

            // è¨­å®šã®ãƒ‘ãƒ¼ã‚¹ã¨æ¤œè¨¼
            function parseSettings() {
                settingsError.textContent = '';
                gameConfig.gridRows = parseInt(gridRowsInput.value);
                gameConfig.gridCols = parseInt(gridColsInput.value);
                // waypointsCount ã¯ã€ç¾åœ¨é…ç½®ã•ã‚Œã¦ã„ã‚‹æ•°ã¨ã™ã‚‹
                gameConfig.waypointsCount = gameConfig.waypoints.length;

                try {
                    if (!gameConfig.start) throw new Error('ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    if (!gameConfig.goal) throw new Error('ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const coords = [gameConfig.start, gameConfig.goal, ...gameConfig.waypoints, ...gameConfig.walls];
                    const coordSet = new Set();
                    for (const coord of coords) {
                        const str = coordToString(coord);
                        if (coordSet.has(str)) {
                            throw new Error('ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚´ãƒ¼ãƒ«ã€é€šéåœ°ç‚¹ã€é€šè¡Œä¸å¯ã®åº§æ¨™ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚');
                        }
                        coordSet.add(str);
                    }

                    return true;
                } catch (error) {
                    settingsError.textContent = error.message;
                    return false;
                }
            }

            // --- 4. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ (Game View) ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ã€Œè¨­å®šã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
            backToSettingsBtn.addEventListener('click', showSettingsView);

            // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (å¾©æ´»)
            modeAbsoluteBtn.addEventListener('click', () => setMoveMode('absolute'));
            modeRelativeBtn.addEventListener('click', () => setMoveMode('relative'));

            function setMoveMode(mode) {
                gameState.moveMode = mode;
                gameState.sequence = []; // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                updateSequenceDisplay();
                resetPlayer(); // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚‚ãƒªã‚»ãƒƒãƒˆ

                if (mode === 'absolute') {
                    modeAbsoluteBtn.classList.add('active');
                    modeRelativeBtn.classList.remove('active');
                    directionPad.innerHTML = `
                        <div class="grid grid-cols-3 grid-rows-3 gap-2 justify-items-center items-center w-full h-full">
                            <div class="col-start-2 row-start-1">
                                <button data-action="up" class="dir-btn p-2 text-2xl transition">â¬†ï¸</button>
                            </div>
                            <div class="col-start-1 row-start-2">
                                <button data-action="left" class="dir-btn p-2 text-2xl transition">â¬…ï¸</button>
                            </div>
                            <div class="col-start-3 row-start-2">
                                <button data-action="right" class="dir-btn p-2 text-2xl transition">â¡ï¸</button>
                            </div>
                            <div class="col-start-2 row-start-3">
                                <button data-action="down" class="dir-btn p-2 text-2xl transition">â¬‡ï¸</button>
                            </div>
                        </div>
                    `;
                } else { // relative
                    modeAbsoluteBtn.classList.remove('active');
                    modeRelativeBtn.classList.add('active');
                    directionPad.innerHTML = `
                        <div class="grid grid-cols-3 gap-2 w-full h-full items-center">
                            <button data-action="turnLeft" class="dir-btn operation-btn">
                                <span class="turn-left-icon">â¤´ï¸</span> å·¦ã‚’å‘ã
                            </button>
                            <button data-action="forward" class="dir-btn operation-btn">
                                â¬†ï¸ ç›´é€²ã™ã‚‹
                            </button>
                            <button data-action="turnRight" class="dir-btn operation-btn">
                                <span class="turn-right-icon">â¤µï¸</span> å³ã‚’å‘ã
                            </button>
                        </div>
                    `;
                }
                // æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                addDirectionButtonListeners();
            }

            // æ–¹å‘ãƒœã‚¿ãƒ³ (å‹•çš„ç”Ÿæˆã®ãŸã‚å§”è­²)
            function addDirectionButtonListeners() {
                directionPad.querySelectorAll('.dir-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        if (gameState.isRunning) return;
                        const action = button.dataset.action;
                        gameState.sequence.push(action);
                        updateSequenceDisplay();
                    });
                });
            }

            // ã€Œæˆ»ã™ (UNDO)ã€ãƒœã‚¿ãƒ³
            undoBtn.addEventListener('click', () => {
                if (gameState.isRunning) return;
                gameState.sequence.pop();
                updateSequenceDisplay();
            });

            // ã€Œãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ (ã‚¯ãƒªã‚¢)
            resetBtn.addEventListener('click', async () => {
                await initAudio(); // ã‚µã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
                if (gameState.isRunning) return;
                gameState.sequence = [];
                updateSequenceDisplay();
                // resetPlayer(); // ã“ã“ã§ã¯ãªãã€generateMapã®å¾Œã«å‘¼ã¶
                generateMap(); // ãƒãƒƒãƒ—ï¼ˆæ¶ˆãˆãŸã‚¢ã‚¤ãƒ†ãƒ ï¼‰ã‚’å†æç”»
                resetPlayer(); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã«é…ç½®
                messageArea.textContent = 'ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
                setTimeout(() => messageArea.textContent = '', 2000);
            });

            // ã€Œå®Ÿè¡Œ (RUN)ã€ãƒœã‚¿ãƒ³
            runBtn.addEventListener('click', async () => {
                await initAudio(); // ã‚µã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
                if (gameState.isRunning || gameState.sequence.length === 0) return;
                runSequence();
            });

            // --- 5. ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ ---

            function showSettingsView() {
                gameView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                gameState.sequence = [];
                updateSequenceDisplay();
                messageArea.textContent = '';
                setMoveMode('absolute'); // è¨­å®šç”»é¢ã«æˆ»ã£ãŸã‚‰çµ¶å¯¾æ–¹ä½ã«ãƒªã‚»ãƒƒãƒˆ
            }

            function showGameView() {
                settingsView.classList.add('hidden');
                gameView.classList.remove('hidden');
                generateMap();
                resetPlayer();
                setMoveMode('absolute'); // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã¯å¿…ãšçµ¶å¯¾æ–¹ä½ã‹ã‚‰
            }

            // --- 6. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

            // ãƒãƒƒãƒ—ç”Ÿæˆ
            function generateMap() {
                gridContainer.innerHTML = '';
                gridContainer.style.gridTemplateColumns = `repeat(${gameConfig.gridCols}, minmax(0, 1fr))`;
                
                // ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã«åŸºã¥ã„ã¦ã‚»ãƒ«ã®ã‚µã‚¤ã‚ºã‚’æ±ºå®š
                const parentElement = gridContainer.parentElement;
                const containerWidth = parentElement.clientWidth - 32; // p-4ã®åˆ†ã‚’å¼•ã
                const containerHeight = parentElement.clientHeight - 32; // p-4ã®åˆ†ã‚’å¼•ã

                // ç¸¦æ¨ªã©ã¡ã‚‰ãŒåˆ¶ç´„ã«ãªã‚‹ã‹
                let cellSize = Math.min(
                    containerWidth / gameConfig.gridCols,
                    containerHeight / gameConfig.gridRows
                );
                
                // ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
                gridContainer.style.width = `${cellSize * gameConfig.gridCols}px`;
                gridContainer.style.height = `${cellSize * gameConfig.gridRows}px`;

                // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ã‚»ãƒ«ã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
                const fontSize = cellSize * 0.4; // ã‚»ãƒ«ã‚µã‚¤ã‚ºã®40%

                for (let r = 0; r < gameConfig.gridRows; r++) {
                    for (let c = 0; c < gameConfig.gridCols; c++) {
                        const cell = document.createElement('div');
                        cell.id = `cell-${r}-${c}`;
                        cell.className = 'grid-cell';
                        cell.style.fontSize = `${fontSize}px`; // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å‹•çš„ã«è¨­å®š

                        // è¦ç´ ã®é…ç½® (å£ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã€ã‚´ãƒ¼ãƒ«)
                        if (gameConfig.walls.some(w => w.row === r && w.col === c)) {
                            cell.textContent = 'âŒ';
                        } else if (r === gameConfig.goal.row && c === gameConfig.goal.col) {
                            cell.textContent = 'ğŸ ';
                        } else {
                            const waypoint = gameConfig.waypoints.find(wp => wp.row === r && wp.col === c);
                            if (waypoint) {
                                cell.textContent = waypoint.icon;
                            }
                        }
                        gridContainer.appendChild(cell);
                    }
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚è¨­å®š
                playerElement.style.fontSize = `${fontSize * 0.8}px`; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å°‘ã—å°ã•ã
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ– (ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«æˆ»ã™)
            function resetPlayer() {
                // [FIX] ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ãŒæœªè¨­å®šã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ (åˆæœŸåŒ–æ™‚ã‚¨ãƒ©ãƒ¼é˜²æ­¢)
                if (!gameConfig.start) {
                    // console.warn("resetPlayer called, but gameConfig.start is not set.");
                    return;
                }
                gameState.player.row = gameConfig.start.row;
                gameState.player.col = gameConfig.start.col;
                
                // [FIX] ã“ã“ã‹ã‚‰ãŒå¾©å…ƒã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰
                changeDirection('up'); // å‘ãã‚’ãƒªã‚»ãƒƒãƒˆ
                gameState.collectedWaypoints.clear();
                
                const startCell = document.getElementById(`cell-${gameConfig.start.row}-${gameConfig.start.col}`);
                if (startCell) {
                    playerElement.remove(); // æ—¢å­˜ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
                    startCell.appendChild(playerElement);
                }
            }

            // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Ÿè¡Œ
            async function runSequence() {
                gameState.isRunning = true;
                setButtonsDisabled(true);
                messageArea.textContent = 'å®Ÿè¡Œä¸­...';
                
                resetPlayer(); // å®Ÿè¡Œå‰ã«ãƒªã‚»ãƒƒãƒˆ
                await delay(300);

                for (const action of gameState.sequence) {
                    let nextRow = gameState.player.row;
                    let nextCol = gameState.player.col;
                    let didMove = false;

                    // 1. å‘ãã®æ±ºå®š (ç›¸å¯¾/çµ¶å¯¾)
                    if (gameState.moveMode === 'absolute') {
                        changeDirection(action);
                        if (action === 'up') nextRow--;
                        else if (action === 'down') nextRow++;
                        else if (action === 'left') nextCol--;
                        else if (action === 'right') nextCol++;
                        didMove = true;
                    } else { // relative
                        const currentDir = gameState.player.dir;
                        if (action === 'forward') {
                            changeDirection(currentDir); // å‘ãã¯ãã®ã¾ã¾
                            if (currentDir === 'up') nextRow--;
                            else if (currentDir === 'down') nextRow++;
                            else if (currentDir === 'left') nextCol--;
                            else if (currentDir === 'right') nextCol++;
                            didMove = true;
                        } else if (action === 'turnRight') {
                            const dirMap = { 'up': 'right', 'right': 'down', 'down': 'left', 'left': 'up' };
                            changeDirection(dirMap[currentDir]);
                        } else if (action === 'turnLeft') {
                            const dirMap = { 'up': 'left', 'left': 'down', 'down': 'right', 'right': 'up' };
                            changeDirection(dirMap[currentDir]);
                        }
                    }
                    
                    if (didMove) {
                        // 2. ãƒãƒƒãƒ—å¤–ãƒã‚§ãƒƒã‚¯
                        if (nextRow < 0 || nextRow >= gameConfig.gridRows || nextCol < 0 || nextCol >= gameConfig.gridCols) {
                            messageArea.textContent = 'ãƒãƒƒãƒ—ã®å¤–ã«å‡ºã¾ã—ãŸï¼';
                            break; // å®Ÿè¡Œä¸­æ–­
                        }
                        // 3. å£ãƒã‚§ãƒƒã‚¯
                        const isWall = gameConfig.walls.some(wall => wall.row === nextRow && wall.col === nextCol);
                        if (isWall) {
                            messageArea.textContent = 'é€šè¡Œä¸å¯ã§ã™ï¼';
                            break; // å®Ÿè¡Œä¸­æ–­
                        }

                        // 4. ç§»å‹•
                        gameState.player.row = nextRow;
                        gameState.player.col = nextCol;
                        const nextCell = document.getElementById(`cell-${nextRow}-${nextCol}`);
                        if (nextCell) {
                            nextCell.appendChild(playerElement);
                        }
                        
                        // 5. é€šéåœ°ç‚¹ãƒã‚§ãƒƒã‚¯
                        const isWaypoint = gameConfig.waypoints.some(wp => wp.row === nextRow && wp.col === nextCol);
                        if (isWaypoint) {
                            const coordStr = coordToString({row: nextRow, col: nextCol});
                            if (!gameState.collectedWaypoints.has(coordStr)) {
                                gameState.collectedWaypoints.add(coordStr);
                                playTone(440, 0.1); // åˆ°ç€éŸ³
                                if (nextCell) {
                                    showEffect(nextCell, 'collect'); // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ

                                    // ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ï¼‰ã‚’æ¢ã—ã¦æ¶ˆã™
                                    const textNode = Array.from(nextCell.childNodes).find(node => 
                                        node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== ''
                                    );
                                    if (textNode) {
                                        textNode.textContent = ''; // ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¶ˆã™
                                    }
                                }
                            }
                        }
                    }

                    await delay(300);
                }

                // 6. æœ€çµ‚åˆ¤å®š
                const atGoal = gameState.player.row === gameConfig.goal.row && gameState.player.col === gameConfig.goal.col;
                // gameConfig.waypointsCount ã¯ã€Œè¨­å®šã•ã‚ŒãŸã€é€šéåœ°ç‚¹ã®æ•°
                const allWaypoints = gameState.collectedWaypoints.size === gameConfig.waypointsCount; 

                if (atGoal && allWaypoints) {
                    messageArea.textContent = 'ğŸ‰ ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ‰';
                    playTone(880, 0.5); // ã‚¯ãƒªã‚¢éŸ³
                    const goalCell = document.getElementById(`cell-${gameConfig.goal.row}-${gameConfig.goal.col}`);
                    if (goalCell) {
                        showEffect(goalCell, 'goal'); // ã‚´ãƒ¼ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    }
                } else if (atGoal) {
                    messageArea.textContent = `ã‚´ãƒ¼ãƒ«ï¼ã§ã‚‚é€šéåœ°ç‚¹ãŒ... (${gameState.collectedWaypoints.size}/${gameConfig.waypointsCount})`;
                } else if (messageArea.textContent === 'å®Ÿè¡Œä¸­...') {
                    messageArea.textContent = 'ã‚´ãƒ¼ãƒ«ã«ãŸã©ã‚Šç€ã‘ã¾ã›ã‚“ã§ã—ãŸ';
                }

                gameState.isRunning = false;
                setButtonsDisabled(false);
            }

            // å‘ãã®å¤‰æ›´ (å†…éƒ¨çŠ¶æ…‹ + è¡¨ç¤º)
            function changeDirection(dir) {
                gameState.player.dir = dir; // å†…éƒ¨çŠ¶æ…‹ã‚’æ›´æ–°
                if (dir === 'up') {
                    playerElement.innerHTML = '<span class="text-green-600">â–²</span>';
                } else if (dir === 'down') {
                    playerElement.innerHTML = '<span class="text-green-600">â–¼</span>';
                } else if (dir === 'left') {
                    playerElement.innerHTML = '<span class="text-green-600">â—€</span>';
                } else if (dir === 'right') {
                    playerElement.innerHTML = '<span class="text-green-600">â–¶</span>';
                }
            }
            
            // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨ç¤ºã®æ›´æ–°
            function updateSequenceDisplay() {
                const dirMap = { 
                    'up': 'â¬†ï¸', 'down': 'â¬‡ï¸', 'left': 'â¬…ï¸', 'right': 'â¡ï¸',
                    'forward': 'ç›´', 'turnLeft': 'å·¦', 'turnRight': 'å³'
                };
                sequenceDisplay.innerHTML = gameState.sequence.map(action => 
                    `<span class="p-1 bg-gray-100 rounded">${dirMap[action]}</span>`
                ).join('');
            }

            // å®Ÿè¡Œä¸­ãªã©ã«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            function setButtonsDisabled(disabled) {
                runBtn.disabled = disabled;
                resetBtn.disabled = disabled;
                undoBtn.disabled = disabled;
                backToSettingsBtn.disabled = disabled;
                modeAbsoluteBtn.disabled = disabled; // å¾©æ´»
                modeRelativeBtn.disabled = disabled; // å¾©æ´»
                directionPad.querySelectorAll('.dir-btn').forEach(btn => btn.disabled = disabled);
                
                const buttons = [runBtn, resetBtn, undoBtn, modeAbsoluteBtn, modeRelativeBtn, ...directionPad.querySelectorAll('.dir-btn')];
                buttons.forEach(btn => {
                    if (disabled) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            }

            // --- 7. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

            function coordToString(coord) {
                if (!coord) return ''; // null ãƒã‚§ãƒƒã‚¯
                return `${coord.row},${coord.col}`;
            }

            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function getRandomCoord(rows, cols, usedCoords) {
                let r, c, str;
                do {
                    r = getRandomInt(0, rows - 1);
                    c = getRandomInt(0, cols - 1);
                    str = coordToString({ row: r, col: c });
                } while (usedCoords.has(str));
                return { row: r, col: c };
            }

            function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // --- ã‚µã‚¦ãƒ³ãƒ‰é–¢æ•° ---
            async function initAudio() {
                if (synth) return;
                try {
                    await Tone.start();
                    synth = new Tone.Synth().toDestination();
                    console.log("Audio context started");
                } catch (e) {
                    console.error("Failed to start audio context:", e);
                }
            }

            function playTone(note, duration) {
                if (synth) {
                    synth.triggerAttackRelease(note, duration);
                }
            }

            // --- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ---
            function showEffect(element, type) {
                if (!element) return;
                if (type === 'collect') {
                    // pingã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆã‚¢ã‚¤ãƒ†ãƒ å–å¾—ï¼‰
                    const effectEl = document.createElement('div');
                    effectEl.className = 'effect-ping';
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼(span)ã®å‰ã«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ(div)ã‚’æŒ¿å…¥
                    const playerEl = element.querySelector('#player');
                    if (playerEl) {
                        element.insertBefore(effectEl, playerEl);
                    } else {
                        element.appendChild(effectEl);
                    }
                    setTimeout(() => effectEl.remove(), 1000);
                } else if (type === 'goal') {
                    // tadaã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆã‚´ãƒ¼ãƒ«ï¼‰
                    element.classList.add('effect-tada');
                    setTimeout(() => element.classList.remove('effect-tada'), 1000);
                }
            }


            // --- 8. PWAã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ² ---
            // (PWAæ©Ÿèƒ½ã¯ `sw.js` ã¨ `manifest.json` ã«ä¾å­˜)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered!', reg))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }

            // --- 9. åˆæœŸåŒ– ---
            updateSettingGrid();
            setMoveMode('absolute'); // åˆæœŸãƒ¢ãƒ¼ãƒ‰ã‚’ 'absolute' ã«è¨­å®š (ã“ã®ä¸­ã§ addDirectionButtonListeners ãŒå‘¼ã°ã‚Œã‚‹)
            randomAllBtn.click(); // åˆæœŸçŠ¶æ…‹ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
        });
    </script>
</body>
</html>
